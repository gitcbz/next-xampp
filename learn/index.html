<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数学大冒险 - 算数游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', '微软雅黑', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* 背景动画 */
        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }

        .math-symbol {
            position: absolute;
            font-size: 30px;
            color: rgba(255, 255, 255, 0.1);
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        /* 游戏容器 */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 90%;
            animation: slideIn 0.5s ease-out;
            position: relative;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* 游戏头部 */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 48px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
            margin-bottom: 10px;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .game-subtitle {
            font-size: 18px;
            color: #666;
        }

        /* 年级选择 */
        .grade-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .grade-btn {
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: bold;
            color: #2d3436;
            position: relative;
            overflow: hidden;
        }

        .grade-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .grade-btn:hover::before {
            animation: shine 0.5s ease;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); opacity: 0; }
        }

        .grade-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: #4ecdc4;
        }

        .grade-btn.selected {
            background: linear-gradient(135deg, #4ecdc4, #44a3aa);
            color: white;
            border-color: #2d3436;
            transform: scale(1.05);
        }

        /* 游戏区域 */
        .game-area {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 400px;
            position: relative;
        }

        /* 状态栏 */
        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .status-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3436;
        }

        .status-value.accuracy {
            color: #4ecdc4;
        }

        .status-value.exp {
            color: #ff6b6b;
        }

        .status-value.level {
            color: #6c5ce7;
        }

        .status-value.difficulty {
            color: #fdcb6e;
        }

        /* 倒计时条 */
        .timer-container {
            margin-bottom: 25px;
        }

        .timer-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a3aa, #2d3436);
            transition: width 0.1s linear;
            border-radius: 15px;
            position: relative;
        }

        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: white;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* 题目区域 */
        .question-area {
            text-align: center;
            margin-bottom: 30px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-size: 18px;
            color: #666;
        }

        .difficulty-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .difficulty-badge.easy {
            background: linear-gradient(135deg, #55efc4, #00b894);
        }

        .difficulty-badge.medium {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
        }

        .difficulty-badge.hard {
            background: linear-gradient(135deg, #ff7675, #d63031);
        }

        .question-text {
            font-size: 36px;
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* 答案区域 */
        .answer-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .choice-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .choice-btn {
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
            position: relative;
        }

        .choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: #4ecdc4;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .choice-btn.correct {
            background: linear-gradient(135deg, #55efc4, #00b894);
            color: white;
            border-color: #00b894;
            animation: correctAnswer 0.5s ease;
        }

        .choice-btn.incorrect {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: white;
            border-color: #d63031;
            animation: incorrectAnswer 0.5s ease;
        }

        @keyframes correctAnswer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes incorrectAnswer {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fill-input {
            width: 100%;
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 15px;
            font-size: 24px;
            text-align: center;
            transition: all 0.3s;
        }

        .fill-input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
        }

        /* 控制按钮 */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .start-btn {
            background: linear-gradient(135deg, #4ecdc4, #44a3aa);
        }

        .submit-btn {
            background: linear-gradient(135deg, #55efc4, #00b894);
        }

        .restart-btn {
            background: linear-gradient(135deg, #fd79a8, #e84393);
        }

        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* 游戏结束画面 */
        .game-over {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            border-radius: 20px;
            color: white;
        }

        .game-over h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }

        .final-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .stars {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .star {
            display: inline-block;
            animation: starPop 0.5s ease;
            animation-fill-mode: both;
        }

        .star:nth-child(1) { animation-delay: 0.1s; }
        .star:nth-child(2) { animation-delay: 0.2s; }
        .star:nth-child(3) { animation-delay: 0.3s; }

        @keyframes starPop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        /* 返回按钮 */
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* 经验值动画 */
        .exp-animation {
            position: fixed;
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            pointer-events: none;
            z-index: 1000;
            animation: expFloat 2s ease-out forwards;
        }

        @keyframes expFloat {
            0% { 
                transform: translateY(0) scale(0.5);
                opacity: 1;
            }
            100% { 
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        /* 等级提升动画 */
        .level-up {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            z-index: 2000;
            animation: levelUpAnimation 2s ease-out forwards;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes levelUpAnimation {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(360deg);
                opacity: 0;
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }

            .game-title {
                font-size: 32px;
            }

            .grade-selection {
                grid-template-columns: repeat(2, 1fr);
            }

            .choice-container {
                grid-template-columns: 1fr;
            }

            .question-text {
                font-size: 28px;
            }

            .status-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .control-buttons {
                flex-direction: column;
            }
        }

        /* 版权信息 */
        .copyright-footer {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            text-align: center;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- 背景动画 -->
    <div class="bg-animation" id="bgAnimation"></div>

    <!-- 返回按钮 -->
    <a href="../index.html" class="back-btn">
        <span>←</span>
        <span>返回主页</span>
    </a>

    <!-- 游戏容器 -->
    <div class="game-container">
        <!-- 游戏头部 -->
        <div class="game-header">
            <h1 class="game-title">数学大冒险</h1>
            <p class="game-subtitle">挑战你的数学能力，获得经验值升级！</p>
        </div>

        <!-- 年级选择 -->
        <div class="grade-selection" id="gradeSelection">
            <button class="grade-btn" data-grade="1" onclick="selectGrade(1)">一年级</button>
            <button class="grade-btn" data-grade="2" onclick="selectGrade(2)">二年级</button>
            <button class="grade-btn" data-grade="3" onclick="selectGrade(3)">三年级</button>
            <button class="grade-btn" data-grade="4" onclick="selectGrade(4)">四年级</button>
            <button class="grade-btn" data-grade="5" onclick="selectGrade(5)">五年级</button>
            <button class="grade-btn" data-grade="6" onclick="selectGrade(6)">六年级</button>
            <button class="grade-btn" data-grade="7" onclick="selectGrade(7)">七年级</button>
            <button class="grade-btn" data-grade="8" onclick="selectGrade(8)">八年级</button>
            <button class="grade-btn" data-grade="9" onclick="selectGrade(9)">九年级</button>
        </div>

        <!-- 游戏区域 -->
        <div class="game-area" id="gameArea">
            <!-- 开始界面 -->
            <div id="startScreen">
                <div style="text-align: center; padding: 40px;">
                    <h2 style="font-size: 28px; color: #2d3436; margin-bottom: 20px;">准备好了吗？</h2>
                    <p style="font-size: 18px; color: #666; margin-bottom: 30px;">选择年级，开始你的数学冒险！<br>难度会逐渐增加，答对题目获得经验值！</p>
                    <button class="control-btn start-btn" onclick="startGame()">开始游戏</button>
                </div>
            </div>

            <!-- 游戏进行界面 -->
            <div id="gameScreen" style="display: none;">
                <!-- 状态栏 -->
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-label">等级</div>
                        <div class="status-value level" id="level">Lv.1</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">经验值</div>
                        <div class="status-value exp" id="exp">0/100</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">准确率</div>
                        <div class="status-value accuracy" id="accuracy">100%</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">得分</div>
                        <div class="status-value" id="score">0</div>
                    </div>
                </div>

                <!-- 倒计时条 -->
                <div class="timer-container">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timerFill">
                            <span class="timer-text" id="timerText">30</span>
                        </div>
                    </div>
                </div>

                <!-- 题目区域 -->
                <div class="question-area">
                    <div class="question-header">
                        <div class="question-number" id="questionNumber">第 1 题</div>
                        <div class="difficulty-badge easy" id="difficultyBadge">简单</div>
                    </div>
                    <div class="question-text" id="questionText">准备开始...</div>
                </div>

                <!-- 答案区域 -->
                <div class="answer-area" id="answerArea">
                    <!-- 动态生成 -->
                </div>

                <!-- 控制按钮 -->
                <div class="control-buttons">
                    <button class="control-btn submit-btn" id="submitBtn" onclick="submitAnswer()">提交答案</button>
                </div>
            </div>

            <!-- 游戏结束界面 -->
            <div id="gameOverScreen" style="display: none;">
                <div class="game-over">
                    <h2>游戏结束！</h2>
                    <div class="final-stats">
                        <div class="stat-item">
                            <div class="stat-label">最终得分</div>
                            <div class="stat-value" id="finalScore">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">最终准确率</div>
                            <div class="stat-value" id="finalAccuracy">0%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">获得经验</div>
                            <div class="stat-value" id="totalExp">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">达到等级</div>
                            <div class="stat-value" id="finalLevel">Lv.1</div>
                        </div>
                    </div>
                    <div class="stars" id="stars"></div>
                    <p style="font-size: 18px; margin-bottom: 30px;" id="resultMessage">继续努力！</p>
                    <button class="control-btn restart-btn" onclick="restartGame()">再玩一次</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 版权信息 -->
    <footer class="copyright-footer">
        <p>©2025 CBZ Studio 版权所有</p>
    </footer>

    <script>
        // 游戏状态
        let gameState = {
            grade: null,
            score: 0,
            currentQuestion: 0,
            totalQuestions: 20,
            timeLeft: 30,
            timer: null,
            isPlaying: false,
            currentAnswer: null,
            correctAnswers: 0,
            totalAnswers: 0,
            currentDifficulty: 'easy',
            difficultyProgress: 0,
            level: 1,
            exp: 0,
            expToNext: 100,
            totalExpGained: 0
        };

        // 题目生成器
        class QuestionGenerator {
            static generateQuestion(grade, difficulty) {
                let question = {};
                
                switch(grade) {
                    case 1: return this.generateGrade1(difficulty);
                    case 2: return this.generateGrade2(difficulty);
                    case 3: return this.generateGrade3(difficulty);
                    case 4: return this.generateGrade4(difficulty);
                    case 5: return this.generateGrade5(difficulty);
                    case 6: return this.generateGrade6(difficulty);
                    case 7: return this.generateGrade7(difficulty);
                    case 8: return this.generateGrade8(difficulty);
                    case 9: return this.generateGrade9(difficulty);
                    default: return this.generateGrade1(difficulty);
                }
            }

            static generateGrade1(difficulty) {
                const operations = ['+', '-'];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                let a, b, answer;
                
                if (difficulty === 'easy') {
                    a = Math.floor(Math.random() * 10) + 1;
                    b = Math.floor(Math.random() * 10) + 1;
                } else if (difficulty === 'medium') {
                    a = Math.floor(Math.random() * 20) + 1;
                    b = Math.floor(Math.random() * 20) + 1;
                } else {
                    a = Math.floor(Math.random() * 50) + 1;
                    b = Math.floor(Math.random() * 50) + 1;
                }
                
                if (operation === '-' && a < b) [a, b] = [b, a];
                answer = operation === '+' ? a + b : a - b;
                
                return {
                    text: `${a} ${operation} ${b} = ?`,
                    answer: answer,
                    type: 'fill',
                    choices: this.generateChoices(answer, difficulty)
                };
            }

            static generateGrade2(difficulty) {
                const operations = ['+', '-', '×'];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                let a, b, answer;
                
                if (difficulty === 'easy') {
                    a = Math.floor(Math.random() * 20) + 1;
                    b = Math.floor(Math.random() * 20) + 1;
                    if (operation === '×') {
                        a = Math.floor(Math.random() * 10) + 1;
                        b = Math.floor(Math.random() * 10) + 1;
                    }
                } else if (difficulty === 'medium') {
                    a = Math.floor(Math.random() * 50) + 1;
                    b = Math.floor(Math.random() * 50) + 1;
                    if (operation === '×') {
                        a = Math.floor(Math.random() * 12) + 1;
                        b = Math.floor(Math.random() * 12) + 1;
                    }
                } else {
                    a = Math.floor(Math.random() * 100) + 1;
                    b = Math.floor(Math.random() * 100) + 1;
                    if (operation === '×') {
                        a = Math.floor(Math.random() * 15) + 1;
                        b = Math.floor(Math.random() * 15) + 1;
                    }
                }
                
                if (operation === '-' && a < b) [a, b] = [b, a];
                answer = operation === '+' ? a + b : operation === '-' ? a - b : a * b;
                
                return {
                    text: `${a} ${operation} ${b} = ?`,
                    answer: answer,
                    type: Math.random() > 0.5 ? 'choice' : 'fill',
                    choices: this.generateChoices(answer, difficulty)
                };
            }

            static generateGrade3(difficulty) {
                const operations = ['+', '-', '×', '÷'];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                let a, b, answer;
                
                if (difficulty === 'easy') {
                    a = Math.floor(Math.random() * 50) + 1;
                    b = Math.floor(Math.random() * 50) + 1;
                    if (operation === '×') {
                        a = Math.floor(Math.random() * 12) + 1;
                        b = Math.floor(Math.random() * 12) + 1;
                    } else if (operation === '÷') {
                        b = Math.floor(Math.random() * 10) + 1;
                        a = b * (Math.floor(Math.random() * 10) + 1);
                    }
                } else if (difficulty === 'medium') {
                    a = Math.floor(Math.random() * 100) + 1;
                    b = Math.floor(Math.random() * 100) + 1;
                    if (operation === '×') {
                        a = Math.floor(Math.random() * 20) + 1;
                        b = Math.floor(Math.random() * 20) + 1;
                    } else if (operation === '÷') {
                        b = Math.floor(Math.random() * 20) + 1;
                        a = b * (Math.floor(Math.random() * 20) + 1);
                    }
                } else {
                    a = Math.floor(Math.random() * 200) + 1;
                    b = Math.floor(Math.random() * 200) + 1;
                    if (operation === '×') {
                        a = Math.floor(Math.random() * 30) + 1;
                        b = Math.floor(Math.random() * 30) + 1;
                    } else if (operation === '÷') {
                        b = Math.floor(Math.random() * 30) + 1;
                        a = b * (Math.floor(Math.random() * 30) + 1);
                    }
                }
                
                if (operation === '-' && a < b) [a, b] = [b, a];
                answer = operation === '+' ? a + b : operation === '-' ? a - b : operation === '×' ? a * b : a / b;
                
                return {
                    text: `${a} ${operation} ${b} = ?`,
                    answer: answer,
                    type: 'choice',
                    choices: this.generateChoices(answer, difficulty)
                };
            }

            static generateGrade4(difficulty) {
                const operations = ['+', '-', '×', '÷'];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                let a, b, answer;
                
                if (difficulty === 'easy') {
                    a = (Math.floor(Math.random() * 100) + 1) / 10;
                    b = (Math.floor(Math.random() * 100) + 1) / 10;
                } else if (difficulty === 'medium') {
                    a = (Math.floor(Math.random() * 1000) + 1) / 100;
                    b = (Math.floor(Math.random() * 1000) + 1) / 100;
                } else {
                    a = (Math.floor(Math.random() * 10000) + 1) / 1000;
                    b = (Math.floor(Math.random() * 10000) + 1) / 1000;
                }
                
                if (operation === '÷') {
                    answer = a / b;
                } else {
                    answer = operation === '+' ? a + b : operation === '-' ? a - b : a * b;
                }
                
                return {
                    text: `${a} ${operation} ${b} = ?`,
                    answer: Math.round(answer * 100) / 100,
                    type: 'fill',
                    choices: this.generateChoices(answer, difficulty)
                };
            }

            static generateGrade5(difficulty) {
                const operations = ['+', '-', '×', '÷'];
                const operation = operations[Math.floor(Math.random() * operations.length)];
                
                let aNum = Math.floor(Math.random() * 10) + 1;
                let aDen = Math.floor(Math.random() * 10) + 1;
                let bNum = Math.floor(Math.random() * 10) + 1;
                let bDen = Math.floor(Math.random() * 10) + 1;
                
                let answer;
                if (operation === '+') {
                    answer = (aNum * bDen + bNum * aDen) / (aDen * bDen);
                } else if (operation === '-') {
                    answer = (aNum * bDen - bNum * aDen) / (aDen * bDen);
                } else if (operation === '×') {
                    answer = (aNum * bNum) / (aDen * bDen);
                } else {
                    answer = (aNum * bDen) / (aDen * bNum);
                }
                
                return {
                    text: `${aNum}/${aDen} ${operation} ${bNum}/${bDen} = ?`,
                    answer: Math.round(answer * 100) / 100,
                    type: 'choice',
                    choices: this.generateChoices(answer, difficulty)
                };
            }

            static generateGrade6(difficulty) {
                const types = ['percent', 'ratio', 'equation'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                if (type === 'percent') {
                    const base = Math.floor(Math.random() * 100) + 1;
                    const percent = Math.floor(Math.random() * 100) + 1;
                    const answer = (base * percent) / 100;
                    
                    return {
                        text: `${base} 的 ${percent}% 是多少？`,
                        answer: Math.round(answer * 100) / 100,
                        type: 'fill',
                        choices: this.generateChoices(answer, difficulty)
                    };
                } else if (type === 'ratio') {
                    const a = Math.floor(Math.random() * 10) + 1;
                    const b = Math.floor(Math.random() * 10) + 1;
                    const total = (a + b) * (Math.floor(Math.random() * 10) + 1);
                    const answer = (total * a) / (a + b);
                    
                    return {
                        text: `比例 ${a}:${b}，总和为 ${total}，求第一项`,
                        answer: Math.round(answer * 100) / 100,
                        type: 'choice',
                        choices: this.generateChoices(answer, difficulty)
                    };
                } else {
                    const x = Math.floor(Math.random() * 20) + 1;
                    const a = Math.floor(Math.random() * 10) + 1;
                    const b = Math.floor(Math.random() * 20) + 1;
                    const answer = x;
                    
                    return {
                        text: `${a}x + ${b} = ${a * x + b}，求 x`,
                        answer: answer,
                        type: 'fill',
                        choices: this.generateChoices(answer, difficulty)
                    };
                }
            }

            static generateGrade7(difficulty) {
                const types = ['linear', 'system', 'inequality'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                if (type === 'linear') {
                    const a = Math.floor(Math.random() * 10) + 1;
                    const b = Math.floor(Math.random() * 20) + 1;
                    const x = Math.floor(Math.random() * 10) + 1;
                    const c = a * x + b;
                    
                    return {
                        text: `${a}x + ${b} = ${c}，求 x`,
                        answer: x,
                        type: 'fill',
                        choices: this.generateChoices(x, difficulty)
                    };
                } else if (type === 'system') {
                    const x = Math.floor(Math.random() * 10) + 1;
                    const y = Math.floor(Math.random() * 10) + 1;
                    const a1 = Math.floor(Math.random() * 5) + 1;
                    const b1 = Math.floor(Math.random() * 5) + 1;
                    const a2 = Math.floor(Math.random() * 5) + 1;
                    const b2 = Math.floor(Math.random() * 5) + 1;
                    
                    return {
                        text: `方程组：${a1}x + ${b1}y = ${a1*x + b1*y}，${a2}x + ${b2}y = ${a2*x + b2*y}，求 x + y`,
                        answer: x + y,
                        type: 'choice',
                        choices: this.generateChoices(x + y, difficulty)
                    };
                } else {
                    const a = Math.floor(Math.random() * 10) + 1;
                    const b = Math.floor(Math.random() * 20) + 1;
                    const x = Math.floor(Math.random() * 10) + 1;
                    const sign = Math.random() > 0.5 ? '>' : '<';
                    const c = sign === '>' ? a * x + b + Math.floor(Math.random() * 5) + 1 : a * x + b - Math.floor(Math.random() * 5) - 1;
                    
                    return {
                        text: `${a}x + ${b} ${sign} ${c}，求 x 的最小整数值`,
                        answer: sign === '>' ? Math.floor((c - b) / a) + 1 : Math.ceil((c - b) / a) - 1,
                        type: 'choice',
                        choices: this.generateChoices(0, difficulty)
                    };
                }
            }

            static generateGrade8(difficulty) {
                const types = ['area', 'pythagorean', 'angle'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                if (type === 'area') {
                    const shapes = ['rectangle', 'triangle', 'circle'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    
                    if (shape === 'rectangle') {
                        const length = Math.floor(Math.random() * 20) + 5;
                        const width = Math.floor(Math.random() * 20) + 5;
                        return {
                            text: `长方形长 ${length}cm，宽 ${width}cm，求面积`,
                            answer: length * width,
                            type: 'fill',
                            choices: this.generateChoices(length * width, difficulty)
                        };
                    } else if (shape === 'triangle') {
                        const base = Math.floor(Math.random() * 20) + 5;
                        const height = Math.floor(Math.random() * 20) + 5;
                        return {
                            text: `三角形底 ${base}cm，高 ${height}cm，求面积`,
                            answer: (base * height) / 2,
                            type: 'fill',
                            choices: this.generateChoices((base * height) / 2, difficulty)
                        };
                    } else {
                        const radius = Math.floor(Math.random() * 10) + 1;
                        return {
                            text: `圆半径 ${radius}cm，求面积（π=3.14）`,
                            answer: Math.round(3.14 * radius * radius * 100) / 100,
                            type: 'fill',
                            choices: this.generateChoices(3.14 * radius * radius, difficulty)
                        };
                    }
                } else if (type === 'pythagorean') {
                    const a = Math.floor(Math.random() * 10) + 3;
                    const b = Math.floor(Math.random() * 10) + 3;
                    const c = Math.round(Math.sqrt(a * a + b * b) * 100) / 100;
                    
                    return {
                        text: `直角三角形两直角边分别为 ${a}cm 和 ${b}cm，求斜边长度`,
                        answer: c,
                        type: 'fill',
                        choices: this.generateChoices(c, difficulty)
                    };
                } else {
                    const angle1 = Math.floor(Math.random() * 80) + 10;
                    const angle2 = Math.floor(Math.random() * (90 - angle1)) + 1;
                    const angle3 = 180 - angle1 - angle2;
                    
                    return {
                        text: `三角形两个角分别为 ${angle1}° 和 ${angle2}°，求第三个角`,
                        answer: angle3,
                        type: 'choice',
                        choices: this.generateChoices(angle3, difficulty)
                    };
                }
            }

            static generateGrade9(difficulty) {
                const types = ['quadratic', 'statistics', 'probability'];
                const type = types[Math.floor(Math.random() * types.length)];
                
                if (type === 'quadratic') {
                    const a = Math.floor(Math.random() * 5) + 1;
                    const b = Math.floor(Math.random() * 20) - 10;
                    const c = Math.floor(Math.random() * 20) - 10;
                    const discriminant = b * b - 4 * a * c;
                    
                    if (discriminant >= 0) {
                        const x1 = Math.round((-b + Math.sqrt(discriminant)) / (2 * a) * 100) / 100;
                        const x2 = Math.round((-b - Math.sqrt(discriminant)) / (2 * a) * 100) / 100;
                        
                        return {
                            text: `二次函数 ${a}x² + ${b}x + ${c} = 0，求较大根`,
                            answer: Math.max(x1, x2),
                            type: 'fill',
                            choices: this.generateChoices(Math.max(x1, x2), difficulty)
                        };
                    } else {
                        return this.generateGrade9(difficulty);
                    }
                } else if (type === 'statistics') {
                    const numbers = [];
                    for (let i = 0; i < 5; i++) {
                        numbers.push(Math.floor(Math.random() * 50) + 10);
                    }
                    const sum = numbers.reduce((a, b) => a + b, 0);
                    const mean = sum / numbers.length;
                    
                    return {
                        text: `数据：${numbers.join(', ')}，求平均值`,
                        answer: Math.round(mean * 100) / 100,
                        type: 'fill',
                        choices: this.generateChoices(mean, difficulty)
                    };
                } else {
                    const total = Math.floor(Math.random() * 20) + 10;
                    const favorable = Math.floor(Math.random() * total) + 1;
                    const probability = favorable / total;
                    
                    return {
                        text: `袋中有 ${total} 个球，其中 ${favorable} 个红球，求摸到红球的概率`,
                        answer: Math.round(probability * 100) / 100,
                        type: 'choice',
                        choices: this.generateChoices(probability, difficulty)
                    };
                }
            }

            static generateChoices(correctAnswer, difficulty) {
                const choices = [correctAnswer];
                const choiceCount = 4;
                
                while (choices.length < choiceCount) {
                    let wrongAnswer;
                    if (typeof correctAnswer === 'number') {
                        const variance = Math.max(Math.abs(correctAnswer) * 0.3, 1);
                        wrongAnswer = Math.round((correctAnswer + (Math.random() - 0.5) * variance * 2) * 100) / 100;
                    } else {
                        wrongAnswer = Math.floor(Math.random() * 100) + 1;
                    }
                    
                    if (!choices.includes(wrongAnswer)) {
                        choices.push(wrongAnswer);
                    }
                }
                
                return choices.sort(() => Math.random() - 0.5);
            }
        }

        // 初始化背景动画
        function initBackground() {
            const bgAnimation = document.getElementById('bgAnimation');
            const symbols = ['+', '-', '×', '÷', '=', 'π', '√', '∑', '∞', '∫'];
            
            for (let i = 0; i < 20; i++) {
                const symbol = document.createElement('div');
                symbol.className = 'math-symbol';
                symbol.textContent = symbols[Math.floor(Math.random() * symbols.length)];
                symbol.style.left = Math.random() * 100 + '%';
                symbol.style.top = Math.random() * 100 + '%';
                symbol.style.animationDelay = Math.random() * 10 + 's';
                symbol.style.animationDuration = (Math.random() * 10 + 10) + 's';
                bgAnimation.appendChild(symbol);
            }
        }

        // 选择年级
        function selectGrade(grade) {
            document.querySelectorAll('.grade-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`[data-grade="${grade}"]`).classList.add('selected');
            gameState.grade = grade;
        }

        // 开始游戏
        function startGame() {
            if (!gameState.grade) {
                alert('请选择年级！');
                return;
            }
            
            // 重置游戏状态
            gameState.score = 0;
            gameState.currentQuestion = 0;
            gameState.correctAnswers = 0;
            gameState.totalAnswers = 0;
            gameState.isPlaying = true;
            gameState.currentDifficulty = 'easy';
            gameState.difficultyProgress = 0;
            gameState.totalExpGained = 0;
            
            // 更新界面
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('gradeSelection').style.display = 'none';
            
            // 更新状态显示
            updateStatusDisplay();
            
            // 开始第一题
            nextQuestion();
        }

        // 下一题
        function nextQuestion() {
            if (gameState.currentQuestion >= gameState.totalQuestions) {
                endGame();
                return;
            }
            
            gameState.currentQuestion++;
            gameState.timeLeft = 30;
            
            // 更新难度进度
            updateDifficulty();
            
            // 更新题目编号
            document.getElementById('questionNumber').textContent = `第 ${gameState.currentQuestion} 题`;
            
            // 生成新题目
            const question = QuestionGenerator.generateQuestion(gameState.grade, gameState.currentDifficulty);
            gameState.currentAnswer = question.answer;
            
            // 显示题目和难度
            document.getElementById('questionText').textContent = question.text;
            updateDifficultyDisplay();
            
            // 生成答案区域
            const answerArea = document.getElementById('answerArea');
            answerArea.innerHTML = '';
            
            if (question.type === 'choice') {
                const choiceContainer = document.createElement('div');
                choiceContainer.className = 'choice-container';
                
                question.choices.forEach((choice, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = choice;
                    btn.onclick = () => selectChoice(btn, choice);
                    choiceContainer.appendChild(btn);
                });
                
                answerArea.appendChild(choiceContainer);
            } else {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'fill-input';
                input.placeholder = '请输入答案';
                input.id = 'fillAnswer';
                answerArea.appendChild(input);
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        submitAnswer();
                    }
                });
            }
            
            // 开始倒计时
            startTimer();
        }

        // 更新难度
        function updateDifficulty() {
            const progress = gameState.currentQuestion / gameState.totalQuestions;
            
            if (progress < 0.33) {
                gameState.currentDifficulty = 'easy';
            } else if (progress < 0.67) {
                gameState.currentDifficulty = 'medium';
            } else {
                gameState.currentDifficulty = 'hard';
            }
        }

        // 更新难度显示
        function updateDifficultyDisplay() {
            const badge = document.getElementById('difficultyBadge');
            badge.className = 'difficulty-badge ' + gameState.currentDifficulty;
            
            const difficultyText = {
                'easy': '简单',
                'medium': '中等',
                'hard': '困难'
            };
            
            badge.textContent = difficultyText[gameState.currentDifficulty];
        }

        // 选择答案
        function selectChoice(btn, choice) {
            document.querySelectorAll('.choice-btn').forEach(b => {
                b.style.borderColor = '#ddd';
            });
            
            btn.style.borderColor = '#4ecdc4';
            gameState.selectedAnswer = choice;
        }

        // 提交答案
        function submitAnswer() {
            if (!gameState.isPlaying) return;
            
            let userAnswer;
            if (document.getElementById('fillAnswer')) {
                userAnswer = parseFloat(document.getElementById('fillAnswer').value);
            } else {
                userAnswer = gameState.selectedAnswer;
            }
            
            if (userAnswer === undefined || userAnswer === null) {
                alert('请选择或输入答案！');
                return;
            }
            
            // 停止计时器
            clearInterval(gameState.timer);
            
            // 更新答题统计
            gameState.totalAnswers++;
            
            // 检查答案
            const isCorrect = Math.abs(userAnswer - gameState.currentAnswer) < 0.01;
            
            if (isCorrect) {
                gameState.correctAnswers++;
                const points = calculateScore();
                const expGained = calculateExp();
                
                gameState.score += points;
                gameState.exp += expGained;
                gameState.totalExpGained += expGained;
                
                // 显示经验值动画
                showExpAnimation(expGained);
                
                // 检查升级
                checkLevelUp();
                
                // 显示正确答案
                if (document.querySelectorAll('.choice-btn').length > 0) {
                    document.querySelectorAll('.choice-btn').forEach(btn => {
                        if (parseFloat(btn.textContent) === gameState.currentAnswer) {
                            btn.classList.add('correct');
                        } else if (parseFloat(btn.textContent) === userAnswer) {
                            btn.classList.add('incorrect');
                        }
                    });
                }
            } else {
                // 显示错误答案
                if (document.querySelectorAll('.choice-btn').length > 0) {
                    document.querySelectorAll('.choice-btn').forEach(btn => {
                        if (parseFloat(btn.textContent) === gameState.currentAnswer) {
                            btn.classList.add('correct');
                        } else if (parseFloat(btn.textContent) === userAnswer) {
                            btn.classList.add('incorrect');
                        }
                    });
                }
            }
            
            // 更新显示
            updateStatusDisplay();
            
            // 禁用所有输入
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = true;
            });
            if (document.getElementById('fillAnswer')) {
                document.getElementById('fillAnswer').disabled = true;
            }
            
            // 1秒后自动进入下一题
            setTimeout(() => {
                nextQuestion();
            }, 1000);
        }

        // 计算得分
        function calculateScore() {
            let baseScore = 10;
            
            // 根据年级调整分数
            baseScore += gameState.grade * 2;
            
            // 根据难度调整分数
            if (gameState.currentDifficulty === 'medium') baseScore *= 1.5;
            if (gameState.currentDifficulty === 'hard') baseScore *= 2;
            
            // 根据剩余时间调整分数
            baseScore *= (1 + gameState.timeLeft / 60);
            
            return Math.round(baseScore);
        }

        // 计算经验值
        function calculateExp() {
            let baseExp = 10;
            
            // 根据难度调整经验值
            if (gameState.currentDifficulty === 'medium') baseExp *= 1.5;
            if (gameState.currentDifficulty === 'hard') baseExp *= 2;
            
            // 根据答题速度调整经验值
            baseExp *= (1 + gameState.timeLeft / 60);
            
            return Math.round(baseExp);
        }

        // 显示经验值动画
        function showExpAnimation(exp) {
            const expElement = document.createElement('div');
            expElement.className = 'exp-animation';
            expElement.textContent = `+${exp} EXP`;
            expElement.style.left = '50%';
            expElement.style.top = '50%';
            expElement.style.transform = 'translate(-50%, -50%)';
            
            document.body.appendChild(expElement);
            
            setTimeout(() => {
                expElement.remove();
            }, 2000);
        }

        // 检查升级
        function checkLevelUp() {
            while (gameState.exp >= gameState.expToNext) {
                gameState.exp -= gameState.expToNext;
                gameState.level++;
                gameState.expToNext = gameState.level * 100;
                
                // 显示升级动画
                showLevelUpAnimation();
            }
        }

        // 显示升级动画
        function showLevelUpAnimation() {
            const levelUpElement = document.createElement('div');
            levelUpElement.className = 'level-up';
            levelUpElement.textContent = `升级！Lv.${gameState.level}`;
            
            document.body.appendChild(levelUpElement);
            
            setTimeout(() => {
                levelUpElement.remove();
            }, 2000);
        }

        // 更新状态显示
        function updateStatusDisplay() {
            document.getElementById('level').textContent = `Lv.${gameState.level}`;
            document.getElementById('exp').textContent = `${gameState.exp}/${gameState.expToNext}`;
            document.getElementById('score').textContent = gameState.score;
            
            // 更新准确率
            const accuracy = gameState.totalAnswers > 0 
                ? Math.round((gameState.correctAnswers / gameState.totalAnswers) * 100) 
                : 100;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
        }

        // 开始倒计时
        function startTimer() {
            updateTimer();
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimer();
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    submitAnswer();
                }
            }, 1000);
        }

        // 更新倒计时显示
        function updateTimer() {
            const timerFill = document.getElementById('timerFill');
            const timerText = document.getElementById('timerText');
            
            const percentage = (gameState.timeLeft / 30) * 100;
            timerFill.style.width = percentage + '%';
            timerText.textContent = gameState.timeLeft;
            
            if (gameState.timeLeft <= 10) {
                timerFill.style.background = 'linear-gradient(90deg, #ff7675, #d63031)';
            }
        }

        // 结束游戏
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.timer);
            
            // 显示结束界面
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            
            // 计算最终统计
            const finalAccuracy = gameState.totalAnswers > 0 
                ? Math.round((gameState.correctAnswers / gameState.totalAnswers) * 100) 
                : 0;
            
            // 显示最终统计
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalAccuracy').textContent = `${finalAccuracy}%`;
            document.getElementById('totalExp').textContent = gameState.totalExpGained;
            document.getElementById('finalLevel').textContent = `Lv.${gameState.level}`;
            
            // 计算星级
            let stars = 0;
            let message = '';
            
            if (finalAccuracy >= 90) {
                stars = 3;
                message = '太棒了！你是数学天才！🌟';
            } else if (finalAccuracy >= 70) {
                stars = 2;
                message = '很好！继续加油！💪';
            } else if (finalAccuracy >= 50) {
                stars = 1;
                message = '不错！再接再厉！📚';
            } else {
                stars = 0;
                message = '需要多练习哦！🎯';
            }
            
            // 显示星星
            const starsContainer = document.getElementById('stars');
            starsContainer.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const star = document.createElement('span');
                star.className = 'star';
                star.textContent = i < stars ? '⭐' : '☆';
                starsContainer.appendChild(star);
            }
            
            // 显示消息
            document.getElementById('resultMessage').textContent = message;
        }

        // 重新开始游戏
        function restartGame() {
            // 重置界面
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            
            // 显示年级选择
            document.getElementById('gradeSelection').style.display = 'grid';
            
            // 重置选择状态
            document.querySelectorAll('.grade-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 重置游戏状态
            gameState.grade = null;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            initBackground();
        });
    </script>
</body>
</html>
